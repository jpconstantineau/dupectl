# Implementation Plan: Duplicate Scan System

**Branch**: `001-duplicate-scan-system-01` | **Date**: December 23, 2025 | **Spec**: [spec.md](../001-duplicate-scan-system/spec.md)
**Input**: Feature specification from `specs/001-duplicate-scan-system/spec.md`

**Note**: This plan was generated by the `speckit.plan` command for Golang implementation on Windows with GoReleaser multi-platform builds.

## Summary

Implement duplicate file and folder detection system for DupeCTL that recursively scans registered root folders, calculates cryptographic hashes (SHA-512 default, SHA-256, SHA3-256 options), and identifies duplicates based on size AND hash matching. System supports three scan modes: scan all (folders + files), scan folders only (quick hierarchy registration), and scan files only (hash existing folders). Features include checkpoint/resume capability for interruption handling, configurable parallel processing with worker pools, progress indication with braille spinner, and graceful shutdown within 5 seconds on SIGINT/SIGTERM. Database schema uses SQLite with WAL mode, dedicated scan tables (files, folders, scan_state) with foreign key relationships to existing infrastructure, and optimized indexes for duplicate queries. Implementation follows clean architecture with domain separation (pkg/entities/), application services (pkg/scanner/, pkg/hash/, pkg/duplicate/), infrastructure layer (pkg/datastore/), and worker pool concurrency (internal/worker/). Testing strategy targets ≥70% coverage with 70/20/10 split (unit/integration/e2e tests) and test fixtures in repository.

## Technical Context

<!--
  ACTION REQUIRED: Replace the content in this section with the technical details
  for the project. The structure here is presented in advisory capacity to guide
  the iteration process.
-->

**Language/Version**: Go 1.21+ (leverages goroutines for concurrent scanning, standard library crypto/hash for hashing)  
**Primary Dependencies**: `spf13/cobra` (CLI framework, already present), `spf13/viper` (configuration, already present), `modernc.org/sqlite` (embedded database with WAL mode, already present), `crypto/sha256`, `crypto/sha512`, `golang.org/x/crypto/sha3` (hash algorithms from stdlib + golang.org/x)  
**Storage**: SQLite with WAL mode, dedicated scan tables (files, folders, scan_state) with foreign keys to existing infrastructure tables (agents, hosts, root_folders), parameterized queries, connection pooling for concurrent access  
**Testing**: Go standard testing (`go test`), table-driven tests, coverage target ≥70% (80% for core logic), test fixtures in `tests/fixtures/` or `testdata/`, unit tests (70%) > integration tests (20%) > e2e tests (10%)  
**Target Platform**: Windows (primary development), multi-platform release via GoReleaser (Windows, Linux, macOS), container-compatible with checkpoint persistence, cross-platform paths via `filepath` package  
**Project Type**: CLI (single project type, Golang project structure with cmd/ and pkg/)  
**Performance Goals**: Hash throughput ≥50 MB/sec (NFR-001), Memory <500 MB for 100K files (NFR-002), Scan speed 10K files <5 min (SC-001), Graceful shutdown <5 sec (NFR-008), Folder traversal ≥1000 files/sec  
**Constraints**: Zero data loss on graceful shutdown (checkpoint saved), container-compatible (resume across restarts), no external service dependencies (embedded DB only), checkpoint within 5 seconds on SIGINT/SIGTERM  
**Scale/Scope**: Multiple root folders with independent config, 100K+ files supported, configurable worker pools (default: CPU cores, max: 100), database supports millions of records with indexed queries

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with DupeCTL Constitution (v1.0.0):

- [x] **Clean Code & Quality**: Functions single-purpose (FR-007: separate concerns per NFR-007), descriptive names (FR requirement IDs self-documenting), <50 lines target, low complexity (scan/hash/detect as separate modules)
- [x] **Clean Architecture**: Domain logic separated (pkg/entities/ for domain, pkg/scanner/ for application, pkg/datastore/ for infrastructure per FR-004.1), dependencies point inward (domain has zero external deps), no circular deps (folder traversal → hashing → storage hierarchy)
- [x] **Testing**: Test coverage ≥70% target (NFR-014: 80% for core logic), test types identified (FR-026: integration, FR-027: database, FR-030: signal handling, FR-031: concurrent ops, FR-032: containerized)
- [x] **UX Consistency**: Commands follow verb-noun pattern (scan all, get duplicates per FR-001, FR-017), error messages actionable (NFR-006: permission errors with guidance), progress indication (FR-013: --progress with spinner/counts/time)
- [x] **Performance**: Meets defined thresholds (NFR-001: 50 MB/sec hash, NFR-002: <500 MB RAM for 100K files, SC-001: 10K files <5 min, NFR-008: <5 sec shutdown)
- [x] **Dependencies**: Uses Go stdlib first (crypto/sha256, crypto/sha512, filepath per FR-003, NFR-010), new dependencies justified (Cobra/Viper already present, sha3 from golang.org/x for algorithm option per FR-015)
- [x] **Maintainability**: GoDoc comments required (FR-024: CLI help text), no hardcoded paths (A-012: absolute paths stored), config via env/flags (FR-015: config file with viper)
- [x] **Upgradability**: Database migrations planned (NFR-009: schema versioning), backward compatibility (FR-016: hash algorithm type stored for future migrations)
- [x] **Observability**: Logging strategy defined (NFR-005: start/end times, errors, summary), progress visibility (FR-013.1: real-time progress every 10 sec), metrics identified (folders/files processed, duplicates found per SC-006)
- [x] **Portability**: Cross-platform path handling (FR-001.3: filepath package, A-012: platform separators), no OS-specific assumptions (NFR-003: Windows/Linux/macOS identical behavior)
- [x] **Graceful Shutdown**: Signal handling planned (FR-014.1: SIGINT/SIGTERM with checkpoint save), state persistence designed (FR-014: scan_state table), resume capability (FR-014.2: auto-resume from checkpoint, FR-014.4: container-compatible)
- [x] **12-Factor CLI**: Config external (FR-015: viper config file), stateless commands (FR-014: checkpoint in DB not memory), disposable processes (FR-014.4: container stop/start), structured logs (NFR-005: operation logging)

**Violations Requiring Justification**: None - specification fully aligns with all 12 constitutional principles

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)
<!--
  ACTION REQUIRED: Replace the placeholder tree below with the concrete layout
  for this feature. Delete unused options and expand the chosen structure with
  real paths (e.g., apps/admin, packages/something). The delivered plan must
  not include Option labels.
-->

```text
# Golang CLI Project Structure (Single Project)

cmd/                     # CLI commands (thin adapters, Cobra integration)
├── scan.go              # Scan command group (parent)
├── scanAll.go           # Scan all files and folders
├── scanFolders.go       # Scan folders only
├── scanFiles.go         # Scan files only
├── get.go               # Get command group (parent)
├── getDuplicates.go     # Query duplicate files/folders
├── getRoot.go           # List registered root folders
├── add.go               # Add command group (parent)
├── addRoot.go           # Register new root folder
├── delete.go            # Delete command group (parent)
├── deleteRoot.go        # Remove root and scan data
└── root.go              # Root command with Viper config

pkg/                     # Application logic (clean architecture)
├── entities/            # Domain models (pure business logic)
│   ├── files.go         # File entity with hash, timestamps, removed flag
│   ├── folders.go       # Folder entity with hierarchy, error status
│   └── scanstate.go     # Scan checkpoint state
├── scanner/             # Scanning application services
│   ├── scanner.go       # Main scanning orchestrator
│   ├── traverser.go     # Folder tree traversal logic
│   └── progress.go      # Progress reporting (spinner, counts, time)
├── hash/                # File hashing services
│   ├── hasher.go        # Hash calculation interface
│   ├── sha256.go        # SHA-256 implementation
│   ├── sha512.go        # SHA-512 implementation (default)
│   └── sha3.go          # SHA3-256 implementation
├── duplicate/           # Duplicate detection logic
│   ├── detector.go      # Duplicate file/folder detection
│   └── partial.go       # Partial folder duplicate matching
├── datastore/           # Database infrastructure (SQLite)
│   ├── datastore.go     # Database connection and initialization
│   ├── files.go         # Files table operations
│   ├── folders.go       # Folders table operations
│   ├── scanstate.go     # Scan state checkpoint operations
│   ├── migrations.go    # Database schema migrations
│   └── queries.go       # Reusable query patterns
└── checkpoint/          # Checkpoint management
    ├── checkpoint.go    # Save/restore scan checkpoints
    └── signals.go       # Signal handling (SIGINT/SIGTERM)

internal/                # Private application code (not importable)
├── worker/              # Worker pool implementations
│   ├── pool.go          # Generic worker pool
│   ├── traversal.go     # Folder traversal worker
│   └── hashing.go       # File hashing worker
└── config/              # Configuration management
    └── config.go        # Viper configuration wrapper

tests/                   # Test suites
├── fixtures/            # Test data with known characteristics
│   ├── duplicates/      # Exact duplicate files (same content)
│   ├── folders/         # Duplicate folder structures
│   ├── partial/         # Partial folder duplicates
│   └── permissions/     # Files/folders with restricted access
├── unit/                # Unit tests (70% of test suite)
│   ├── hash_test.go     # Hash algorithm tests
│   ├── scanner_test.go  # Scanning logic tests
│   └── detector_test.go # Duplicate detection tests
├── integration/         # Integration tests (20% of test suite)
│   ├── scan_test.go     # Complete scan workflow tests
│   ├── checkpoint_test.go # Checkpoint save/resume tests
│   └── database_test.go # Database operations tests
└── e2e/                 # End-to-end tests (10% of test suite)
    ├── cli_test.go      # Full CLI command tests
    └── container_test.go # Containerized deployment tests

docs/                    # Documentation
├── Installing.md        # Installation guide (existing)
└── design/              # Design documentation (existing)
    ├── agents.md
    ├── files.md
    ├── folder.md
    └── rootfolder.md

specs/                   # Feature specifications
├── 001-duplicate-scan-system/     # Original feature spec
│   ├── spec.md          # Feature specification
│   └── checklists/      # Quality validation checklists
│       ├── ui.md        # User interface requirements (110 checks)
│       ├── database.md  # Database schema & data model (131 checks)
│       └── crud-operations.md  # Entity lifecycle operations (162 checks)
└── 001-duplicate-scan-system-01/  # This implementation plan
    ├── plan.md          # This file
    ├── research.md      # Phase 0 output (COMPLETED)
    ├── data-model.md    # Phase 1 output (COMPLETED)
    ├── quickstart.md    # Phase 1 output (COMPLETED)
    └── contracts/       # Phase 1 output (COMPLETED)
        └── worker-pools.md
```

**Structure Decision**: Single Golang CLI project with clean architecture separation. Uses existing `cmd/` for CLI commands (adapters), `pkg/` for application/domain logic (organized by concern: scanner, hash, duplicate, datastore, entities), and `internal/` for private implementations (worker pools, config). Test suite follows 70/20/10 split (unit/integration/e2e) with dedicated `tests/fixtures/` for test data. This structure aligns with Go conventions and constitution principles (clean architecture, separation of concerns, testability).

## Quality Validation (Checklists)

**Created**: December 24, 2025

### User Interface Checklist
**File**: `specs/001-duplicate-scan-system/checklists/ui.md`  
**Checks**: 110 items | **Focus**: CLI consistency, documentation, clarity  
**Audience**: QA/Test Team (release-gate level)

**Key Findings**:
- ✅ Command signatures fully specified (scan all, scan folders, scan files, get duplicates, get root, add root, delete root)
- ✅ Progress display format documented (braille spinner, counts, elapsed time)
- ⚠️ **48 gaps identified requiring specification enhancement**:
  - Exit codes not defined (CHK006)
  - JSON schema not specified (CHK066-071)
  - Table rendering style not specified (CHK059-065)
  - Configuration file location not documented (CHK046)
  - Non-interactive mode (--yes flag) not specified (CHK076)
  - Localization/accessibility requirements missing (CHK089-092)
  - Short flag aliases not documented (CHK043)
  - Flag combination rules not specified (CHK042)
  - Confirmation prompt timeout/retry behavior not specified (CHK072-075)
  - Help text version display not specified (CHK057)

**Impact**: Specification needs refinement for production readiness. All gaps are testable requirements that QA team needs for comprehensive test planning.

### Database Schema Checklist
**File**: `specs/001-duplicate-scan-system/checklists/database.md`  
**Checks**: 131 items | **Focus**: Schema structure, integrity, performance, best practices  
**Audience**: DBA/Architect + QA/Test Team (standard/thorough level)

**Key Findings**:
- ✅ All entity tables documented with complete column specifications
- ✅ Foreign key relationships explicitly documented with CASCADE rules
- ✅ Indexes documented with performance rationale
- ✅ Query performance targets quantified (<50ms duplicate detection)
- ⚠️ **42 gaps identified requiring specification enhancement**:
  - Foreign key enforcement pragma not documented (CHK029, CHK094)
  - CHECK constraints missing for enums and ranges (CHK036-039)
  - SQLite configuration settings not specified (CHK091-098): page size, cache size, synchronous mode, temp_store, auto_vacuum
  - Transaction boundaries not documented (CHK088)
  - Security considerations not addressed (CHK123-126): SQL injection prevention, file permissions, encryption
  - Zero-size file handling not specified (CHK106)
  - Configuration reload requirements not specified (CHK051)
  - Migration failure handling not specified (CHK056)
  - Query plan optimization strategies not documented (CHK072)

**Impact**: Data model is solid foundation but needs operational details for production deployment. Missing SQLite configuration may impact performance and data safety.

### CRUD Operations Checklist
**File**: `specs/001-duplicate-scan-system/checklists/crud-operations.md`  
**Checks**: 162 items | **Focus**: Entity lifecycle completeness to prevent unmanageable states  
**Audience**: DBA/Architect + QA/Test Team (standard level)

**Key Findings**:
- ✅ Root folder CREATE/READ/DELETE operations fully specified (add root, get root, delete root commands)
- ✅ Scan state CREATE/READ operations automatic (checkpoint save/resume)
- ✅ Files and folders implicit CREATE/UPDATE during scans
- ✅ CASCADE delete prevents orphaned records
- ⚠️ **8 CRITICAL unmanageable states identified** (CHK135-142):
  1. **Files with NULL hash_value**: No rehash operation documented (CHK102, CHK138)
  2. **Removed entities**: No purge operation documented (CHK068, CHK093, CHK112-113, CHK139)
  3. **Stale checkpoints**: No manual clear documented (CHK106, CHK140)
  4. **Error_status entries**: No clear/retry operation documented (CHK103-104, CHK125-128, CHK141)
  5. **Statistics**: No recalculation after deletes documented (CHK130-131, CHK142)
  6. **No consistency check**: No repair operations documented (CHK134)
  7. **No removed flag reversal**: File reappears but flag stuck (CHK062, CHK087)
  8. **No hash algorithm migration**: No rehash strategy documented (CHK107)

**Missing Commands** (preventing full lifecycle management):
- `update root` - modify root_folder configuration (CHK014, CHK151)
- `purge removed` - cleanup removed entities (CHK152)
- `clear errors` - retry after fixing permissions (CHK153)
- `reset checkpoint` - clear stale checkpoints (partially covered by --restart flag, CHK154)
- `recalc stats` - refresh root folder statistics (implicit in issue #5)
- `verify consistency` - detect orphans, invalid FKs, inconsistent data (CHK134)
- `rehash files` - migrate hash algorithms (CHK107)

**Impact**: HIGH PRIORITY - Users can get database into states they cannot recover from without direct DB access. Specification MUST add missing operations before implementation.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations detected - specification fully complies with all constitutional principles. No complexity justification required.

## Specification Enhancement Recommendations

**Priority**: Address before Phase 2 (task breakdown)

### P0 - Critical (Prevents Unmanageable States)
1. **Add missing CRUD operations** (crud-operations.md CHK135-142):
   - Document `purge removed` command for cleanup
   - Document `clear errors` command for retry workflows
   - Document statistics recalculation trigger
   - Document consistency check/repair operations
   - Document hash algorithm migration strategy
   - Document removed flag reversal logic

2. **SQLite configuration** (database.md CHK029, CHK094):
   - Document `PRAGMA foreign_keys = ON` requirement
   - Document WAL mode setup and implications
   - Document synchronous mode choice (FULL for safety)

### P1 - High (Production Readiness)
3. **Exit codes** (ui.md CHK006):
   - Define exit code 0 (success), 1 (user error), 2 (system error)

4. **CHECK constraints** (database.md CHK036-039):
   - Add CHECK for hash_algorithm IN ('sha256', 'sha512', 'sha3-256')
   - Add CHECK for scan_mode IN ('all', 'folders', 'files')
   - Add CHECK for removed IN (0, 1), completed IN (0, 1)
   - Add CHECK for size >= 0, counts >= 0

5. **Security** (database.md CHK123-126):
   - Document parameterized query requirement
   - Document database file permissions (0600)

### P2 - Medium (UX Polish)
6. **JSON schema** (ui.md CHK066-071):
   - Provide complete JSON output schema for `get duplicates --json`
   - Specify field naming (snake_case), timestamp format, encoding

7. **Configuration file** (ui.md CHK046-052):
   - Document file location (~/.dupectl.yaml, --config override)
   - Document reload strategy (requires restart)

8. **Table rendering** (ui.md CHK059-065):
   - Specify table style (ASCII, box-drawing, or library choice)
   - Specify column width rules (truncation with ellipsis)

### P3 - Low (Nice to Have)
9. **Non-interactive mode** (ui.md CHK076):
   - Add --yes flag for scripting (auto-accept confirmations)

10. **Localization** (ui.md CHK089-092):
    - Note: Out of scope for initial release, mark as future enhancement
